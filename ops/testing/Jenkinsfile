def repo = 'ssh://git@github.com/SnowSE/project_aspen.git'

pipeline {
    agent none
    stages {
        stage("Test") {
            agent {
                label 'engineering.snow.edu'
            }
            steps {
                git branch: "${env.BRANCH_NAME}", credentialsId: 'ea61f9dc-d1a9-4eb7-8b4c-441ad8bed5fb', url: "$repo"
                sh """
                  cd ops/testing
                  DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 docker-compose build --parallel --pull
                  docker-compose up -d
                  docker-compose exec -T api_test dotnet test
                  docker-compose exec -T web_test npm run test -- --watchAll=false
                """
            }
        }
    }
    post { 
        always { 
          node('engineering.snow.edu') {
                git branch: "${env.BRANCH_NAME}", credentialsId: 'ea61f9dc-d1a9-4eb7-8b4c-441ad8bed5fb', url: "$repo"
                sh """
                  cd ops/testing
                  docker-compose down 
                """
          }
        }
    }
}